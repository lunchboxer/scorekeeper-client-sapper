{#if stage}
<svelte:component this="{stage}" />
{:else}
<h2>No class session found</h2>
{/if}

<script>
  import client from '../utils/feathers.js'
  import { addMessage } from '../utils/notificationTools.js'
  import ClassSessionActive from './ClassSessionActive.html'
  import ClassSessionStarted from './ClassSessionStarted.html'
  import ClassSessionEnded from './ClassSessionEnded.html'

  export default {
    oncreate() {
      const { session } = this.store.get()
      const { id } = session
      const attendances = client.service('attendances').watch()
        .find({ query: { session: id } })
        .subscribe(res => {
          console.log(res.data)
          this.store.set({ attendances: res.data })
        })
      this.on('destroy', attendances.unsubscribe)

      this.sessions = client.service('class-sessions').watch()
        .get(id).subscribe(session => {
          if (session.stage === 'Inactive') {
            client.service('class-sessions').patch(id, { stage: "Active" })
            this.addMessage('Activated class session')
          }
          this.store.set({ session, activeGroupId: session.studentGroupId })
        })
    },
    ondestroy() {
      this.sessions.unsubscribe()
    },
    computed: {
      stage: ({ $session }) => {
        switch ($session.stage) {
          case 'Active':
            return ClassSessionActive
          case 'Started':
            return ClassSessionStarted
          case 'Ended':
            return ClassSessionEnded
          default:
            return null
        }
      }
    },
    methods: {
      addMessage
    }
  }
</script>