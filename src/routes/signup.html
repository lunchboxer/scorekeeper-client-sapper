<svelte:head>
  <title>Sign up</title>
</svelte:head>

<h1>Sign up</h1>

{#if $login}
<p>You are already logged in.</p>
{:else}
<form on:submit="handleSubmit(event)" novalidate ref:form>
  <fieldset>

    <FancyTextInput label="Username" pattern="^[\u3400-\u9FBF]$" maxlength="20" required description="1-20 letters, numbers and/or _"
      name="usernameField" bind:value=username />

    <FancyTextInput label="Password" pattern="^\w+$" minlength="6" maxlength="20" required description="6-20 letters, numbers and/or _"
      name="passwordField" type="password" bind:value=password />

    <FancyTextInput bind:value=password2 label="Confirm Password" name="password2Field" type="password" maxlength="20"
      pattern={confirmPattern} description="must match with above password" required />

    <br>
    <input class="button" type="submit" value="Submit">
    <a class="button button-outline" href="login">Cancel</a>
    <br>
    <span class="error">{error}</span>
  </fieldset>
</form>
{/if}

<script>
  import client from "../utils/feathers";
  import { goto } from "../../__sapper__/client.js";

  export default {
    data() {
      return {
        username: "",
        password: "",
        password2: "",
        error: ""
      }
    },
    computed: {
      confirmPattern: ({ password }) => `^${password}$`
    },
    components: {
      FancyTextInput: "../components/FancyTextInput.html"
    },
    methods: {
      handleSubmit(event) {
        event.preventDefault()
        const isValid = this.refs.form.checkValidity()
        if (!isValid) {
          this.store.addMessage("Please fix form errors first.");
          return;
        }
        event.target.querySelector("input[type=submit]").disabled = true;
        const { username, password } = this.get()
        client
          .service("users")
          .create({ username, password })
          .then(() => {
            this.store.addMessage("New account created successfully");
            client.authenticate({
              strategy: "local",
              username,
              password
            });
          })
          .then(() => {
            goto("/");
            this.store.addMessage(`Logged in as ${username}.`);
          })
          .catch(error => {
            event.target.querySelector("input[type=submit]").disabled = false;
            this.set({ error: error.message });
            this.store.addMessage("There was a problem signing up.");
          });
      }
    }
  }
</script>