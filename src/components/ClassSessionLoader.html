{#if stage}
<svelte:component this="{stage}" />
{:else}
<h2>No class session found</h2>
{/if}

<script>
  import client from '../utils/feathers.js'
  import ClassSessionActive from './ClassSessionActive.html'
  import ClassSessionStarted from './ClassSessionStarted.html'
  import ClassSessionEnded from './ClassSessionEnded.html'

  export default {
    oncreate() {
      const { session } = this.store.get()
      const { id } = session
      if (!id) {
        this.store.set({ session: {} })
        this.store.addMessage('Error: Session not found')
      }
      this.attendances = client.service('attendances').watch()
        .find({ query: { session: id } })
        .subscribe(res => this.store.set({ attendances: res.data }))
      this.sessions = client.service('class-sessions').watch()
        .get(id).subscribe(session => {
          if (session.stage === 'Inactive') {
            this.activateSession(id)
          }
          this.store.set({ session, activeGroupId: session.studentGroupId })
        })
    },
    ondestroy() {
      this.sessions.unsubscribe()
      this.attendances.unsubscribe()
    },
    computed: {
      stage: ({ $session }) => {
        switch ($session.stage) {
          case 'Active':
            return ClassSessionActive
          case 'Started':
            return ClassSessionStarted
          case 'Ended':
            return ClassSessionEnded
          default:
            return null
        }
      }
    },
    methods: {
      async activateSession(id) {
        // there can be only one active session
        await client.service('class-sessions')
          .patch(null, { stage: "Inactive" }, { query: { stage: "Active" } })
        await client.service('class-sessions')
          .patch(null, { stage: "Ended" }, { query: { stage: "Started" } })
        client.service('class-sessions').patch(id, { stage: "Active" })
        this.store.addMessage('Activated class session')
      }
    }
  }
</script>